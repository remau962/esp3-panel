<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ESP3 Control Panel</title>

<!-- PWA Meta Tags -->
<meta name="application-name" content="ESP3 Panel">
<meta name="description" content="Monitor e controllo tastiera ESP3 via MQTT">
<meta name="theme-color" content="#0a0d12">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ESP3 Panel">

<!-- Manifest inline via data URI -->
<link rel="manifest" href="data:application/manifest+json,{
  %22name%22:%22ESP3%20Control%20Panel%22,
  %22short_name%22:%22ESP3%22,
  %22description%22:%22Monitor%20e%20controllo%20tastiera%20ESP3%20via%20MQTT%22,
  %22start_url%22:%22.%22,
  %22display%22:%22standalone%22,
  %22background_color%22:%22%230a0d12%22,
  %22theme_color%22:%22%230a0d12%22,
  %22orientation%22:%22portrait-primary%22,
  %22icons%22:[
    {%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3E%3Crect%20width='512'%20height='512'%20rx='80'%20fill='%230a0d12'/%3E%3Ctext%20x='256'%20y='340'%20font-size='280'%20text-anchor='middle'%20fill='%2300e5ff'%3E⬡%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%20maskable%22}
  ]
}">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;600;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0a0d12;
    --surface:   #111620;
    --border:    #1e2a3a;
    --accent:    #00e5ff;
    --green:     #00ff88;
    --red:       #ff3c5a;
    --amber:     #ffb300;
    --text:      #c8d8e8;
    --muted:     #4a5a70;
    --glow-g:    0 0 18px #00ff8866;
    --glow-r:    0 0 18px #ff3c5a66;
    --glow-a:    0 0 18px #00e5ff55;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 32px 16px 48px;
    background-image:
      radial-gradient(ellipse 80% 40% at 50% -10%, #0a2a4a44, transparent),
      repeating-linear-gradient(0deg, transparent, transparent 39px, #1e2a3a22 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, #1e2a3a22 40px);
  }

  /* Header */
  header {
    text-align: center;
    margin-bottom: 36px;
  }
  header h1 {
    font-size: clamp(1.4rem, 4vw, 2rem);
    font-weight: 800;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--accent);
    text-shadow: 0 0 24px #00e5ff88;
  }
  header p {
    font-family: 'Share Tech Mono', monospace;
    font-size: .75rem;
    color: var(--muted);
    margin-top: 6px;
    letter-spacing: .08em;
  }

  /* Grid layout */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    width: 100%;
    max-width: 820px;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 22px 24px;
    position: relative;
    overflow: hidden;
    transition: border-color .3s;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: .3;
  }
  .card-label {
    font-size: .72rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
    font-family: 'Share Tech Mono', monospace;
  }
  .card-value {
    font-size: 1.15rem;
    font-weight: 600;
    letter-spacing: .04em;
    transition: color .3s, text-shadow .3s;
  }

  /* States */
  .on   { color: var(--green); text-shadow: var(--glow-g); }
  .off  { color: var(--red);   text-shadow: var(--glow-r); }
  .warn { color: var(--amber); text-shadow: 0 0 14px #ffb30066; }

  /* Pannello display a 3 colonne — full width */
  .card-display {
    grid-column: 1 / -1;
    padding: 22px 24px;
  }
  .display-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  .display-panel {
    background: #080b10;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 12px;
    text-align: center;
    position: relative;
  }
  .display-panel-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: .65rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .display-panel-value {
    font-family: 'Share Tech Mono', monospace;
    letter-spacing: .04em;
    transition: transform .1s, opacity .2s, color .3s, text-shadow .3s;
  }
  /* Tasto — grande */
  #lastkey {
    font-size: 4.5rem;
    color: var(--accent);
    text-shadow: var(--glow-a);
  }
  #lastkey.flash {
    transform: scale(1.18);
    opacity: .7;
  }
  /* Switch e Button — medio */
  #switchval, #buttonval {
    font-size: 1.6rem;
    font-weight: 700;
  }

  /* Control card */
  .card-control {
    grid-column: 1 / -1;
  }
  .control-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  /* Toggle button */
  .btn-toggle {
    flex: 1;
    min-width: 120px;
    padding: 14px 20px;
    border-radius: 8px;
    border: 2px solid;
    font-family: 'Exo 2', sans-serif;
    font-size: .9rem;
    font-weight: 700;
    letter-spacing: .08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background .25s, box-shadow .25s, transform .1s;
    background: transparent;
  }
  .btn-toggle:active { transform: scale(.97); }

  .btn-enable {
    border-color: var(--green);
    color: var(--green);
  }
  .btn-enable:hover {
    background: #00ff8818;
    box-shadow: var(--glow-g);
  }

  .btn-disable {
    border-color: var(--red);
    color: var(--red);
  }
  .btn-disable:hover {
    background: #ff3c5a18;
    box-shadow: var(--glow-r);
  }

  .btn-toggle:disabled {
    opacity: .35;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Log */
  .log-area {
    grid-column: 1 / -1;
    background: #080b10;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    max-height: 180px;
    overflow-y: auto;
  }
  .log-area::-webkit-scrollbar { width: 4px; }
  .log-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  #log {
    font-family: 'Share Tech Mono', monospace;
    font-size: .72rem;
    color: var(--muted);
    line-height: 1.7;
    white-space: pre-wrap;
  }
  #log .l-in  { color: #00e5ffaa; }
  #log .l-out { color: #00ff88aa; }
  #log .l-sys { color: #ffb30099; }
  #log .l-err { color: #ff3c5a99; }

  /* Scrollbar custom for log */
  .log-title {
    font-size: .68rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
    font-family: 'Share Tech Mono', monospace;
  }

  /* Pulse dot */
  .dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
    background: var(--red);
    box-shadow: var(--glow-r);
    transition: background .3s, box-shadow .3s;
  }
  .dot.on { background: var(--green); box-shadow: var(--glow-g); animation: pulse 2s infinite; }
  @keyframes pulse {
    0%,100% { opacity:1; }
    50%      { opacity:.45; }
  }

  /* ---- Tastiera Virtuale ---- */
  .card-vkeypad {
    grid-column: 1 / -1;
  }

  .vkeypad-wrap {
    margin-top: 14px;
    display: inline-grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    width: 100%;
    max-width: 340px;
  }

  .vkey {
    aspect-ratio: 1;
    border-radius: 10px;
    border: 2px solid var(--border);
    background: #0d1520;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.3rem;
    font-weight: 700;
    cursor: pointer;
    transition: background .15s, border-color .15s, box-shadow .15s, transform .1s, color .15s;
    position: relative;
    overflow: hidden;
    user-select: none;
  }

  /* Colori per colonna lettera (A B C D) */
  .vkey.letter {
    border-color: #1a3a5a;
    color: var(--accent);
  }
  .vkey.special {
    border-color: #2a2000;
    color: var(--amber);
  }

  /* Stato abilitato */
  .vkey:not(:disabled):hover {
    background: #152030;
    border-color: var(--accent);
    box-shadow: 0 0 12px #00e5ff33;
  }
  .vkey.letter:not(:disabled):hover {
    border-color: var(--accent);
    box-shadow: 0 0 14px #00e5ff44;
  }
  .vkey.special:not(:disabled):hover {
    border-color: var(--amber);
    box-shadow: 0 0 14px #ffb30044;
  }

  .vkey:active:not(:disabled) {
    transform: scale(.92);
  }

  /* Flash al click */
  .vkey.pressed {
    background: #00e5ff22 !important;
    border-color: var(--accent) !important;
    box-shadow: 0 0 20px #00e5ff66 !important;
  }

  /* Stato disabilitato */
  .vkey:disabled {
    opacity: .2;
    cursor: not-allowed;
  }

  /* Star key — sempre attivo, stile distinto */
  .vkey.star {
    border-color: #1e3a1e;
    color: #44aa44;
    opacity: .5;   /* visivamente smorzato: non invia via MQTT */
    cursor: default;
  }

  .card-name input {
    background: #080b10;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--accent);
    font-family: 'Share Tech Mono', monospace;
    font-size: .95rem;
    padding: 8px 12px;
    width: 100%;
    margin-top: 10px;
    outline: none;
    transition: border-color .2s;
  }
  .card-name input:focus { border-color: var(--accent); }
  .card-name .name-badge {
    display: inline-block;
    margin-top: 10px;
    font-family: 'Share Tech Mono', monospace;
    font-size: .8rem;
    color: var(--green);
    letter-spacing: .08em;
  }
  .card-name .name-hint {
    font-family: 'Share Tech Mono', monospace;
    font-size: .65rem;
    color: var(--muted);
    margin-top: 6px;
  }

  .vkeypad-note {
    font-family: 'Share Tech Mono', monospace;
    font-size: .67rem;
    color: var(--muted);
    margin-top: 10px;
    letter-spacing: .06em;
  }
</style>
</head>
<body>

<header>
  <h1>⬡ ESP3 Control Panel</h1>
  <p>Monitor &amp; controllo tastiera via MQTT / TLS</p>
</header>

<div class="grid">

  <!-- Broker -->
  <div class="card">
    <div class="card-label">Broker MQTT</div>
    <div class="card-value">
      <span class="dot" id="dot-broker"></span>
      <span id="broker" class="off">OFFLINE</span>
    </div>
  </div>

  <!-- ESP3 -->
  <div class="card">
    <div class="card-label">ESP3 Status</div>
    <div class="card-value">
      <span class="dot" id="dot-esp"></span>
      <span id="esp" class="off">OFFLINE</span>
    </div>
  </div>

  <!-- Tastiera stato -->
  <div class="card">
    <div class="card-label">Tastiera</div>
    <div class="card-value">
      <span class="dot" id="dot-keypad"></span>
      <span id="keypad" class="off">DISABILITATA</span>
    </div>
  </div>

  <!-- Nome dispositivo -->
  <div class="card card-name" style="grid-column: 1 / -1;">
    <div class="card-label">Nome Dispositivo</div>
    <div id="name-display" style="display:none">
      <span class="name-badge" id="name-badge"></span>
      <span class="name-hint"> — apparirà nel log seriale di ESP3 e ESP1</span>
      <br><button onclick="editName()" style="margin-top:8px;background:none;border:1px solid var(--muted);color:var(--muted);border-radius:4px;padding:4px 10px;font-size:.7rem;cursor:pointer;font-family:'Share Tech Mono',monospace">✎ Modifica</button>
    </div>
    <div id="name-edit">
      <input type="text" id="name-input" maxlength="16" placeholder="es. PC-Studio oppure Smartphone..."
             onkeydown="if(event.key==='Enter') saveName()">
      <div class="name-hint">Scrivi un nome per questo dispositivo e premi Invio (max 16 caratteri, no spazi)</div>
      <button onclick="saveName()" style="margin-top:8px;background:var(--accent);border:none;color:#000;border-radius:4px;padding:6px 16px;font-size:.8rem;cursor:pointer;font-family:'Share Tech Mono',monospace;font-weight:700">Salva</button>
    </div>
  </div>

  <!-- Display 3 pannelli: Ultimo Tasto | Switch | Button -->
  <div class="card card-display">
    <div class="card-label">Display — ESP3 &amp; ESP1</div>
    <div class="display-grid">

      <!-- Pannello 1: Ultimo Tasto -->
      <div class="display-panel">
        <div class="display-panel-label">⌨ Ultimo Tasto</div>
        <div class="display-panel-value" id="lastkey">—</div>
      </div>

      <!-- Pannello 2: Interruttore -->
      <div class="display-panel">
        <div class="display-panel-label">⬛ Interruttore</div>
        <div class="display-panel-value off" id="switchval">—</div>
      </div>

      <!-- Pannello 3: Pulsante Toggle -->
      <div class="display-panel">
        <div class="display-panel-label">◉ Pulsante Toggle</div>
        <div class="display-panel-value off" id="buttonval">—</div>
      </div>

    </div>
  </div>

  <!-- Controllo remoto -->
  <div class="card card-control">
    <div class="card-label">Controllo Remoto Tastiera</div>
    <div class="control-row">
      <button class="btn-toggle btn-enable" id="btn-enable"  onclick="sendCmd('ABILITA')"   disabled>▶ Abilita</button>
      <button class="btn-toggle btn-disable" id="btn-disable" onclick="sendCmd('DISABILITA')" disabled>■ Disabilita</button>
    </div>
  </div>

  <!-- Tastiera Virtuale -->
  <div class="card card-vkeypad">
    <div class="card-label">Tastiera Virtuale → ESP3</div>
    <div style="text-align:center">
      <div class="vkeypad-wrap" id="vkeypad">
        <!-- Riga 1 -->
        <button class="vkey" data-key="1" disabled>1</button>
        <button class="vkey" data-key="2" disabled>2</button>
        <button class="vkey" data-key="3" disabled>3</button>
        <button class="vkey letter" data-key="A" disabled>A</button>
        <!-- Riga 2 -->
        <button class="vkey" data-key="4" disabled>4</button>
        <button class="vkey" data-key="5" disabled>5</button>
        <button class="vkey" data-key="6" disabled>6</button>
        <button class="vkey letter" data-key="B" disabled>B</button>
        <!-- Riga 3 -->
        <button class="vkey" data-key="7" disabled>7</button>
        <button class="vkey" data-key="8" disabled>8</button>
        <button class="vkey" data-key="9" disabled>9</button>
        <button class="vkey letter" data-key="C" disabled>C</button>
        <!-- Riga 4 -->
        <button class="vkey star" data-key="*" disabled title="Toggle fisico — non inviato">*</button>
        <button class="vkey" data-key="0" disabled>0</button>
        <button class="vkey special" data-key="#" disabled>#</button>
        <button class="vkey letter" data-key="D" disabled>D</button>
      </div>
      <div class="vkeypad-note" id="vkeypad-note">⚠ Tastiera DISABILITATA — attiva prima il keypad</div>
    </div>
  </div>

  <!-- Log -->
  <div class="log-area">
    <div class="log-title">// Activity Log</div>
    <div id="log"></div>
  </div>

</div>

<script>
const BROKER   = "wss://1877065d9ddb47ecb3c5ec8fc01186fb.s1.eu.hivemq.cloud:8884/mqtt";
const TOPIC_SUB_ALL       = "esp3/#";
const TOPIC_SUB_ESP1      = "esp1/#";
const TOPIC_CMD_KEYPAD    = "esp3/cmd/keypad";
const TOPIC_STATUS_ESP    = "esp3/status/esp";
const TOPIC_STATUS_KEYPAD = "esp3/status/keypad";
const TOPIC_KEY           = "esp3/key";
const TOPIC_KEY_WEB       = "esp3/key/web";
const TOPIC_SWITCH        = "esp1/status/switch";
const TOPIC_BUTTON        = "esp1/status/button";

const options = {
  username: "esp32user",
  password: "Esp32Pass123!",
  clientId: "webclient_" + Math.random().toString(16).substring(2, 10),
  clean: true,
  reconnectPeriod: 4000
};

const mqttClient = mqtt.connect(BROKER, options);

// ---- LOG ----
function addLog(text, cls = "") {
  const log = document.getElementById("log");
  const ts  = new Date().toLocaleTimeString("it-IT");
  const line = document.createElement("span");
  if (cls) line.className = cls;
  line.textContent = `[${ts}] ${text}\n`;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

// ---- UI HELPERS ----
function setStatus(id, dotId, text, isOn) {
  const el  = document.getElementById(id);
  const dot = document.getElementById(dotId);
  el.textContent = text;
  el.className   = isOn ? "on" : "off";
  if (isOn) dot.classList.add("on"); else dot.classList.remove("on");
}

function setButtons(enabled) {
  document.getElementById("btn-enable").disabled  = !enabled;
  document.getElementById("btn-disable").disabled = !enabled;
}

// ---- NOME DISPOSITIVO (localStorage) ----
let deviceName = "";

function loadName() {
  const saved = localStorage.getItem("esp3_device_name");
  if (saved && saved.trim().length > 0) {
    deviceName = saved.trim();
    document.getElementById("name-badge").textContent = "▶ " + deviceName;
    document.getElementById("name-display").style.display = "block";
    document.getElementById("name-edit").style.display    = "none";
  } else {
    document.getElementById("name-display").style.display = "none";
    document.getElementById("name-edit").style.display    = "block";
    document.getElementById("name-input").focus();
  }
}

function saveName() {
  let val = document.getElementById("name-input").value.trim().replace(/\s+/g, "-");
  if (val.length === 0) return;
  if (val.length > 16) val = val.substring(0, 16);
  deviceName = val;
  localStorage.setItem("esp3_device_name", deviceName);
  document.getElementById("name-badge").textContent = "▶ " + deviceName;
  document.getElementById("name-display").style.display = "block";
  document.getElementById("name-edit").style.display    = "none";
  addLog(`Nome dispositivo impostato: ${deviceName}`, "l-sys");
}

function editName() {
  document.getElementById("name-input").value = deviceName;
  document.getElementById("name-display").style.display = "none";
  document.getElementById("name-edit").style.display    = "block";
  document.getElementById("name-input").focus();
}

// Carica nome al boot
loadName();

// ---- TASTIERA VIRTUALE ----
let keypadAbilitata = false;

function setVKeypad(abilitata) {
  keypadAbilitata = abilitata;
  const keys = document.querySelectorAll(".vkey:not(.star)");
  const note = document.getElementById("vkeypad-note");
  keys.forEach(btn => { btn.disabled = !abilitata; });
  if (abilitata) {
    note.textContent = "✔ Tastiera ABILITATA — clicca un tasto per inviarlo a ESP3";
    note.style.color = "var(--green)";
  } else {
    note.textContent = "⚠ Tastiera DISABILITATA — attiva prima il keypad";
    note.style.color = "";
  }
}

function sendVKey(key) {
  if (!keypadAbilitata) return;
  if (!mqttClient.connected) {
    addLog("Impossibile inviare — broker non connesso", "l-err");
    return;
  }
  if (!deviceName) {
    addLog("Imposta prima il nome del dispositivo", "l-err");
    document.getElementById("name-input").focus();
    return;
  }
  const payload = JSON.stringify({ tasto: key, client: deviceName });
  mqttClient.publish(TOPIC_KEY_WEB, payload, { retain: false }, (err) => {
    if (err) {
      addLog("Errore invio tasto: " + err.message, "l-err");
    } else {
      addLog(`→ [${TOPIC_KEY_WEB}] ${key}  (${deviceName})`, "l-out");
    }
  });
}

// Binding click su tutti i tasti virtuali (escluso *)
document.querySelectorAll(".vkey:not(.star)").forEach(btn => {
  btn.addEventListener("click", () => {
    const key = btn.dataset.key;
    sendVKey(key);
    // Flash visivo
    btn.classList.add("pressed");
    setTimeout(() => btn.classList.remove("pressed"), 180);
  });
});

// ---- MQTT EVENTS ----
mqttClient.on("connect", () => {
  setStatus("broker", "dot-broker", "ONLINE", true);
  setButtons(true);
  mqttClient.subscribe(TOPIC_SUB_ALL);
  mqttClient.subscribe(TOPIC_SUB_ESP1);
  addLog("Connesso al broker HiveMQ", "l-sys");
});

mqttClient.on("reconnect", () => {
  setStatus("broker", "dot-broker", "RICONNESSIONE...", false);
  setButtons(false);
  addLog("Riconnessione in corso...", "l-sys");
});

mqttClient.on("offline", () => {
  setStatus("broker", "dot-broker", "OFFLINE", false);
  setButtons(false);
  addLog("Broker OFFLINE", "l-err");
});

mqttClient.on("error", (err) => {
  addLog("Errore MQTT: " + err.message, "l-err");
});

// ---- MESSAGGI IN ARRIVO ----
mqttClient.on("message", (topic, message) => {
  const msg = message.toString();
  addLog(`← [${topic}] ${msg}`, "l-in");

  if (topic === TOPIC_STATUS_ESP) {
    setStatus("esp", "dot-esp", msg, msg === "ONLINE");
  }

  if (topic === TOPIC_STATUS_KEYPAD) {
    const on = msg === "ABILITATA";
    setStatus("keypad", "dot-keypad", msg, on);
    setVKeypad(on);
  }

  if (topic === TOPIC_KEY) {
    const el = document.getElementById("lastkey");
    el.textContent = msg;
    el.classList.add("flash");
    setTimeout(() => el.classList.remove("flash"), 200);
  }

  if (topic === TOPIC_SWITCH) {
    const el  = document.getElementById("switchval");
    const isOn = msg === "ON";
    el.textContent = msg;
    el.className   = "display-panel-value " + (isOn ? "on" : "off");
  }

  if (topic === TOPIC_BUTTON) {
    const el  = document.getElementById("buttonval");
    const isOn = msg === "ON";
    el.textContent = msg;
    el.className   = "display-panel-value " + (isOn ? "on" : "off");
  }
});

// ---- INVIO COMANDI ----
function sendCmd(cmd) {
  if (!mqttClient.connected) {
    addLog("Impossibile inviare — broker non connesso", "l-err");
    return;
  }
  mqttClient.publish(TOPIC_CMD_KEYPAD, cmd, { retain: false }, (err) => {
    if (err) {
      addLog("Errore invio comando: " + err.message, "l-err");
    } else {
      addLog(`→ [${TOPIC_CMD_KEYPAD}] ${cmd}`, "l-out");
    }
  });
}

// ================================================================
//  PWA — Service Worker inline (cache offline base)
// ================================================================
const SW_CODE = `
const CACHE = 'esp3-v1';
self.addEventListener('install', e => {
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(clients.claim());
});
self.addEventListener('fetch', e => {
  // Lascia passare tutto — la app richiede connessione MQTT live
  e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
});
`;

if ('serviceWorker' in navigator) {
  const blob = new Blob([SW_CODE], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl, { scope: '/' })
    .then(() => console.log('[PWA] Service Worker registrato'))
    .catch(e => console.warn('[PWA] SW non registrato:', e));
}

// ================================================================
//  PWA — Banner "Aggiungi alla Home" per Android/Chrome
// ================================================================
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Mostra banner nella UI
  const banner = document.getElementById('pwa-banner');
  if (banner) banner.style.display = 'flex';
});

function installPWA() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(choice => {
    if (choice.outcome === 'accepted') {
      addLog('App installata sulla home screen', 'l-sys');
    }
    deferredPrompt = null;
    const banner = document.getElementById('pwa-banner');
    if (banner) banner.style.display = 'none';
  });
}

window.addEventListener('appinstalled', () => {
  addLog('PWA installata con successo', 'l-sys');
  const banner = document.getElementById('pwa-banner');
  if (banner) banner.style.display = 'none';
});
</script>

<!-- PWA Install Banner (appare automaticamente su Android/Chrome) -->
<div id="pwa-banner" style="
  display:none; position:fixed; bottom:0; left:0; right:0;
  background:#111620; border-top:1px solid #00e5ff44;
  padding:14px 20px; align-items:center; justify-content:space-between;
  gap:12px; z-index:9999; font-family:'Exo 2',sans-serif;">
  <div style="color:#c8d8e8; font-size:.9rem;">
    <strong style="color:#00e5ff">⬡ ESP3 Panel</strong><br>
    <span style="font-size:.75rem;color:#4a5a70">Aggiungi alla schermata Home per usarla come app</span>
  </div>
  <button onclick="installPWA()" style="
    background:#00e5ff; color:#000; border:none; border-radius:6px;
    padding:10px 18px; font-weight:700; font-size:.85rem;
    font-family:'Exo 2',sans-serif; cursor:pointer; white-space:nowrap;">
    + Installa
  </button>
</div>

</body>
</html>
